const { computeColumnsToBeSearched } = require('../../../../libx/_runtime/cds-services/services/utils/columns')
const searchToLike = require('./searchToLike')

// convert $search system query option to WHERE/HAVING clause using
// the operator LIKE or CONTAINS
const search2cqn4sql = (cqn, model, options) => {
  const { search2cqn4sql, targetName = cqn.SELECT.from.ref[0] } = options
  const entity = model.definitions[targetName]
  const columns = computeColumnsToBeSearched(cqn, entity)

  // call custom (optimized search to cqn for sql implementation) that tries
  // to optimize the search behavior for a specific database service.
  if (typeof search2cqn4sql === 'function') {
    const search2cqnOptions = { columns, locale: options.locale }
    return search2cqn4sql(cqn, entity, search2cqnOptions)
  }

  const cqnSearchPhrase = cqn.SELECT.search
  const expression = searchToLike(cqnSearchPhrase, columns)

  // REVISIT: find out here if where or having must be used
  cqn._aggregated ? cqn.having(expression) : cqn.where(expression)
}

module.exports = search2cqn4sql
