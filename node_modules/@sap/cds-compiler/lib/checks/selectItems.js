'use strict';

const { forEachGeneric } = require('../model/csnUtils');

// Only to be used with validator.js - a correct this value needs to be provided!

/**
 * Validate select items of a query.
 *
 * @param {CSN.Query} query query object
 */
function validateSelectItems(query) {
  const { SELECT } = query;
  if (!SELECT || !SELECT.columns)
    return;

  forEachGeneric(SELECT, 'columns', (selectItem) => {
    if (selectItem.ref && (selectItem.ref[0] === '$self' || selectItem.ref[0] === '$projection')) {
      const pathStepWithTarget = selectItem._links.slice(1).find(link => link.art.target);
      if (pathStepWithTarget) {
        this.error(null, selectItem.$path,
                   { name: selectItem.ref[0], type: pathStepWithTarget.art.type },
                   'Select items starting with $(NAME) must not contain path steps of type $(TYPE)');
      }
    }
  });
}
module.exports = validateSelectItems;
